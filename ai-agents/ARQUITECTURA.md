# ğŸ“Š ARQUITECTURA COMPLETA - AI Agents System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ğŸ¯ SISTEMA DE AI AGENTS                                â”‚
â”‚                              AppScrum Backend                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 1: USUARIO Y FRONTEND                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ‘¤ Usuario (Product Owner)                                                     â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ Autentica con Clerk                                                      â”‚
â”‚      â”œâ”€ Tiene permisos reales (canManageBacklog, canCreateSprints, etc.)        â”‚
â”‚      â””â”€ Delega permisos especÃ­ficos a los agentes                               â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ HTTP Request con JWT Token
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 2: API ENDPOINTS                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ“¡ /api/ai-agents/                                                             â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ GET    /agents                    â†’ Listar agentes disponibles          â”‚
â”‚      â”œâ”€ GET    /agents/:id                â†’ Ver detalles de agente              â”‚
â”‚      â”œâ”€ POST   /agents                    â†’ Crear agente (super_admin)          â”‚
â”‚      â”œâ”€ PUT    /agents/:id                â†’ Actualizar agente (super_admin)     â”‚
â”‚      â”œâ”€ DELETE /agents/:id                â†’ Eliminar agente (super_admin)       â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ POST   /delegate                  â†’ Delegar permisos                    â”‚
â”‚      â”œâ”€ GET    /my-delegations            â†’ Ver mis delegaciones                â”‚
â”‚      â”œâ”€ DELETE /delegate/:id              â†’ Revocar delegaciÃ³n                  â”‚
â”‚      â”œâ”€ PUT    /delegate/:id/suspend      â†’ Suspender delegaciÃ³n                â”‚
â”‚      â”œâ”€ PUT    /delegate/:id/reactivate   â†’ Reactivar delegaciÃ³n                â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ GET    /actions/my-actions        â†’ Ver acciones ejecutadas             â”‚
â”‚      â””â”€ GET    /metrics/my-usage          â†’ MÃ©tricas de uso                     â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Middleware Chain
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 3: MIDDLEWARE (Seguridad y ValidaciÃ³n)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ›¡ï¸ agentAuth Middleware                                                        â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 1ï¸âƒ£  authenticate()                â†’ Verifica token de Clerk             â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 2ï¸âƒ£  Verifica agente exists       â†’ Busca Agent en DB                   â”‚
â”‚      â”‚      â””â”€ Estado: active                                                    â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 3ï¸âƒ£  Verifica rol del usuario     â†’ agent.canBeUsedBy(user.role)        â”‚
â”‚      â”‚      â””â”€ allowed_roles: [product_owner, super_admin]                      â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 4ï¸âƒ£  Verifica delegaciÃ³n activa   â†’ AgentDelegation.getActiveDelegation()â”‚
â”‚      â”‚      â””â”€ Status: active, no expirada                                       â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 5ï¸âƒ£  Verifica lÃ­mites             â†’ checkLimits()                        â”‚
â”‚      â”‚      â”œâ”€ max_actions_per_hour: 50                                          â”‚
â”‚      â”‚      â”œâ”€ max_actions_per_day: 200                                          â”‚
â”‚      â”‚      â””â”€ max_cost_per_day: $5                                              â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ 6ï¸âƒ£  Verifica permiso especÃ­fico  â†’ delegation.hasPermission()          â”‚
â”‚      â”‚      â””â”€ Ej: canCreateBacklogItems                                         â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â””â”€ 7ï¸âƒ£  Verifica alcance (scope)     â†’ delegation.canAccessProduct()       â”‚
â”‚           â””â”€ Productos permitidos                                                â”‚
â”‚                                                                                   â”‚
â”‚   âœ… Si todo OK â†’ Inyecta req.agent y req.delegation                            â”‚
â”‚   âŒ Si falla â†’ 401/403 con mensaje especÃ­fico                                  â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Request Autorizado
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 4: SERVICIOS DE AGENTES                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ¤– ProductOwnerAgent (Futuro - FASE 3)                                         â”‚
â”‚      â”œâ”€ createUserStory()                                                        â”‚
â”‚      â”œâ”€ refineUserStory()                                                        â”‚
â”‚      â”œâ”€ generateAcceptanceCriteria()                                             â”‚
â”‚      â”œâ”€ prioritizeBacklog()                                                      â”‚
â”‚      â”œâ”€ analyzeBacklog()                                                         â”‚
â”‚      â”œâ”€ analyzeBusinessValue()                                                   â”‚
â”‚      â””â”€ suggestSprintGoal()                                                      â”‚
â”‚                                                                                   â”‚
â”‚   ğŸ­ Orchestrator (Futuro - FASE 2)                                              â”‚
â”‚      â”œâ”€ analyzeIntent()            â†’ Â¿QuÃ© quiere hacer el usuario?              â”‚
â”‚      â”œâ”€ selectAgent()              â†’ Â¿QuÃ© agente debe manejar esto?             â”‚
â”‚      â”œâ”€ coordinateExecution()      â†’ Ejecutar y supervisar                      â”‚
â”‚      â””â”€ aggregateResults()         â†’ Unificar respuestas                        â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Construir Prompt
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 5: AI PROVIDER SERVICE                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ”Œ AIProviderService (PatrÃ³n Strategy)                                         â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ OpenAI Provider                                                          â”‚
â”‚      â”‚   â”œâ”€ GPT-4 Turbo    ($0.01/1K + $0.03/1K)                                â”‚
â”‚      â”‚   â”œâ”€ GPT-4o         ($0.005/1K + $0.015/1K)                              â”‚
â”‚      â”‚   â””â”€ GPT-3.5 Turbo  ($0.0005/1K + $0.0015/1K)                            â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ Anthropic Provider                                                       â”‚
â”‚      â”‚   â”œâ”€ Claude 3.5 Sonnet ($0.003/1K + $0.015/1K)                           â”‚
â”‚      â”‚   â”œâ”€ Claude 3 Opus     ($0.015/1K + $0.075/1K)                           â”‚
â”‚      â”‚   â””â”€ Claude 3 Haiku    ($0.00025/1K + $0.00125/1K)                       â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â””â”€ Google Provider                                                          â”‚
â”‚          â”œâ”€ Gemini 1.5 Pro   ($0.00125/1K + $0.005/1K)                          â”‚
â”‚          â””â”€ Gemini 1.5 Flash ($0.000075/1K + $0.0003/1K) ğŸ’° MÃS BARATO          â”‚
â”‚                                                                                   â”‚
â”‚   MÃ©todos:                                                                        â”‚
â”‚   â”œâ”€ sendPrompt(provider, params)     â†’ Enviar a AI especÃ­fico                  â”‚
â”‚   â”œâ”€ sendPromptAuto(params)           â†’ Auto-selecciÃ³n de provider              â”‚
â”‚   â”œâ”€ estimateTokens(text)             â†’ Estimar costo antes de enviar           â”‚
â”‚   â””â”€ calculateCost(tokens)            â†’ Calcular costo en USD                   â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ AI Response (JSON)
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 6: SERVICIOS DE NEGOCIO (Reutilizar existentes)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ“¦ BacklogService (Futuro - FASE 0 RefactorizaciÃ³n)                            â”‚
â”‚      â”œâ”€ createItem(data)                                                         â”‚
â”‚      â”œâ”€ updateItem(id, updates)                                                  â”‚
â”‚      â”œâ”€ deleteItem(id)                                                           â”‚
â”‚      â”œâ”€ prioritizeBacklog(productId, newOrder)                                   â”‚
â”‚      â””â”€ getItems(filters)                                                        â”‚
â”‚                                                                                   â”‚
â”‚   ğŸ¯ ProductService (Futuro - FASE 0 RefactorizaciÃ³n)                            â”‚
â”‚      â”œâ”€ createProduct(data)                                                      â”‚
â”‚      â”œâ”€ updateProduct(id, updates)                                               â”‚
â”‚      â””â”€ getProducts(filters)                                                     â”‚
â”‚                                                                                   â”‚
â”‚   ğŸƒ SprintService (Futuro - FASE 0 RefactorizaciÃ³n)                             â”‚
â”‚      â”œâ”€ createSprint(data)                                                       â”‚
â”‚      â”œâ”€ updateSprint(id, updates)                                                â”‚
â”‚      â””â”€ planSprint(sprintId, items)                                              â”‚
â”‚                                                                                   â”‚
â”‚   âš¡ CLAVE: Agentes usan los MISMOS servicios que rutas normales                â”‚
â”‚            â†’ No hay duplicaciÃ³n de lÃ³gica                                         â”‚
â”‚            â†’ Mismas validaciones y reglas de negocio                             â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Database Operations
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 7: MODELOS DE DATOS (MongoDB)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ—„ï¸ Modelos Existentes                                                          â”‚
â”‚      â”œâ”€ BacklogItem     â†’ Items del product backlog                             â”‚
â”‚      â”œâ”€ Sprint          â†’ Sprints del proyecto                                   â”‚
â”‚      â”œâ”€ Product         â†’ Productos/Proyectos                                    â”‚
â”‚      â”œâ”€ User            â†’ Usuarios del sistema                                   â”‚
â”‚      â””â”€ ... (otros modelos existentes)                                           â”‚
â”‚                                                                                   â”‚
â”‚   ğŸ¤– Modelos de AI Agents                                                        â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ Agent                                                                    â”‚
â”‚      â”‚   â”œâ”€ name, display_name, type                                             â”‚
â”‚      â”‚   â”œâ”€ configuration (provider, model, temperature)                         â”‚
â”‚      â”‚   â”œâ”€ system_prompt                                                        â”‚
â”‚      â”‚   â”œâ”€ capabilities (array de capacidades)                                  â”‚
â”‚      â”‚   â”œâ”€ context_requirements                                                 â”‚
â”‚      â”‚   â”œâ”€ metrics (uso, tokens, costos)                                        â”‚
â”‚      â”‚   â””â”€ limitations (rate limits)                                            â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ AgentDelegation                                                          â”‚
â”‚      â”‚   â”œâ”€ user_id, agent_id                                                    â”‚
â”‚      â”‚   â”œâ”€ delegated_permissions (array)                                        â”‚
â”‚      â”‚   â”œâ”€ scope (products, limits)                                             â”‚
â”‚      â”‚   â”œâ”€ status (active, suspended, revoked, expired)                         â”‚
â”‚      â”‚   â””â”€ usage_metrics                                                        â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â”œâ”€ AgentAction (AuditorÃ­a)                                                  â”‚
â”‚      â”‚   â”œâ”€ agent_id, user_id, session_id                                        â”‚
â”‚      â”‚   â”œâ”€ action_type                                                          â”‚
â”‚      â”‚   â”œâ”€ input (user_prompt, context)                                         â”‚
â”‚      â”‚   â”œâ”€ ai_response (raw, parsed, reasoning)                                 â”‚
â”‚      â”‚   â”œâ”€ result (status, items_affected, changes)                             â”‚
â”‚      â”‚   â”œâ”€ metrics (tokens, cost, execution_time)                               â”‚
â”‚      â”‚   â”œâ”€ feedback (was_helpful, rating)                                       â”‚
â”‚      â”‚   â””â”€ rollback (can_rollback, rolled_back, original_state)                â”‚
â”‚      â”‚                                                                            â”‚
â”‚      â””â”€ AgentSession                                                             â”‚
â”‚          â”œâ”€ session_id, agent_id, user_id                                        â”‚
â”‚          â”œâ”€ context (product_id, sprint_id, workspace)                           â”‚
â”‚          â”œâ”€ messages (array de conversaciÃ³n)                                     â”‚
â”‚          â”œâ”€ actions_executed                                                     â”‚
â”‚          â”œâ”€ metrics (tokens, cost, duration)                                     â”‚
â”‚          â””â”€ feedback (rating, comment)                                           â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Save + Audit
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CAPA 8: AUDITORÃA Y REGISTRO                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   ğŸ“ AgentAction.create({                                                        â”‚
â”‚        agent_id,                                                                 â”‚
â”‚        user_id,                                                                  â”‚
â”‚        action_type: 'create_backlog_item',                                       â”‚
â”‚        input: { user_prompt: "...", context: {...} },                           â”‚
â”‚        ai_response: { parsed_response, reasoning },                              â”‚
â”‚        result: {                                                                 â”‚
â”‚          status: 'success',                                                      â”‚
â”‚          items_affected: [                                                       â”‚
â”‚            { collection: 'BacklogItem', item_id: '...', operation: 'created' }  â”‚
â”‚          ]                                                                       â”‚
â”‚        },                                                                        â”‚
â”‚        metrics: {                                                                â”‚
â”‚          tokens_used: { total_tokens: 1500 },                                   â”‚
â”‚          cost: 0.03,                                                             â”‚
â”‚          execution_time_ms: 2340                                                 â”‚
â”‚        }                                                                         â”‚
â”‚      })                                                                          â”‚
â”‚                                                                                   â”‚
â”‚   âœ… Toda acciÃ³n queda registrada                                                â”‚
â”‚   âœ… Trazabilidad completa                                                       â”‚
â”‚   âœ… AnÃ¡lisis de costos                                                          â”‚
â”‚   âœ… Capacidad de rollback                                                       â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ CAPAS DE SEGURIDAD                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   Nivel 1: ğŸ” AutenticaciÃ³n Clerk (JWT Token)                                   â”‚
â”‚   Nivel 2: ğŸ‘¤ VerificaciÃ³n de Rol (product_owner, super_admin)                  â”‚
â”‚   Nivel 3: ğŸ“œ DelegaciÃ³n de Permisos (AgentDelegation activa)                   â”‚
â”‚   Nivel 4: âœ… Permiso EspecÃ­fico (canCreateBacklogItems, etc.)                  â”‚
â”‚   Nivel 5: ğŸ¯ Alcance de Productos (scope.products)                             â”‚
â”‚   Nivel 6: â±ï¸  Rate Limiting (acciones/hora, acciones/dÃ­a, costo/dÃ­a)           â”‚
â”‚   Nivel 7: ğŸ“ AuditorÃ­a Completa (AgentAction registra TODO)                    â”‚
â”‚   Nivel 8: â†©ï¸  Rollback (Revertir acciones si es necesario)                     â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° CONTROL DE COSTOS                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   A Nivel de Agente:                                                             â”‚
â”‚   â”œâ”€ max_requests_per_hour: 100                                                 â”‚
â”‚   â”œâ”€ max_tokens_per_day: 100,000                                                â”‚
â”‚   â””â”€ max_cost_per_day: $10                                                      â”‚
â”‚                                                                                   â”‚
â”‚   A Nivel de DelegaciÃ³n:                                                         â”‚
â”‚   â”œâ”€ max_actions_per_hour: 50                                                   â”‚
â”‚   â”œâ”€ max_actions_per_day: 200                                                   â”‚
â”‚   â””â”€ max_cost_per_day: $5                                                       â”‚
â”‚                                                                                   â”‚
â”‚   CÃ¡lculo AutomÃ¡tico:                                                            â”‚
â”‚   â””â”€ calculateCost(provider, model, promptTokens, completionTokens)             â”‚
â”‚                                                                                   â”‚
â”‚   Monitoreo:                                                                     â”‚
â”‚   â”œâ”€ GET /api/ai-agents/metrics/my-usage                                        â”‚
â”‚   â””â”€ Dashboard de mÃ©tricas (Futuro)                                             â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ FLUJO COMPLETO EJEMPLO: CREAR HISTORIA DE USUARIO                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚  1. ğŸ‘¤ Usuario autenticado solicita:                                             â”‚
â”‚     POST /api/ai-agents/product-owner/create-story                              â”‚
â”‚     { "input": "Necesito exportar reportes a PDF", "product_id": "..." }       â”‚
â”‚                                                                                   â”‚
â”‚  2. ğŸ›¡ï¸ Middleware verifica:                                                     â”‚
â”‚     âœ… Token vÃ¡lido                                                              â”‚
â”‚     âœ… Usuario es product_owner                                                  â”‚
â”‚     âœ… Tiene delegaciÃ³n activa                                                   â”‚
â”‚     âœ… DelegaciÃ³n tiene permiso 'canCreateBacklogItems'                          â”‚
â”‚     âœ… No ha excedido lÃ­mites (50 acciones/hora)                                â”‚
â”‚                                                                                   â”‚
â”‚  3. ğŸ¤– ProductOwnerAgent procesa:                                                â”‚
â”‚     â†’ Construye contexto (producto, backlog actual, estÃ¡ndares)                 â”‚
â”‚     â†’ Construye prompt especializado                                             â”‚
â”‚                                                                                   â”‚
â”‚  4. ğŸ”Œ AIProviderService:                                                        â”‚
â”‚     â†’ EnvÃ­a a OpenAI GPT-4 Turbo                                                â”‚
â”‚     â†’ Recibe respuesta JSON estructurada                                         â”‚
â”‚                                                                                   â”‚
â”‚  5. ğŸ“¦ BacklogService:                                                           â”‚
â”‚     â†’ Valida datos generados por AI                                              â”‚
â”‚     â†’ Crea BacklogItem en MongoDB                                                â”‚
â”‚     â†’ Retorna item creado                                                        â”‚
â”‚                                                                                   â”‚
â”‚  6. ğŸ“ AgentAction:                                                              â”‚
â”‚     â†’ Registra toda la operaciÃ³n                                                 â”‚
â”‚     â†’ Guarda input, AI response, item creado                                     â”‚
â”‚     â†’ Calcula tokens (1,500) y costo ($0.03)                                    â”‚
â”‚                                                                                   â”‚
â”‚  7. ğŸ‰ Response al usuario:                                                      â”‚
â”‚     {                                                                             â”‚
â”‚       "success": true,                                                           â”‚
â”‚       "item": { titulo, descripcion, criterios_aceptacion, ... },               â”‚
â”‚       "ai_insights": {                                                           â”‚
â”‚         "reasoning": "CreÃ© esta historia porque...",                            â”‚
â”‚         "suggestions": ["Considera aÃ±adir...", "PodrÃ­as..."]                    â”‚
â”‚       },                                                                         â”‚
â”‚       "metadata": { tokens_used: 1500, cost: 0.03 }                             â”‚
â”‚     }                                                                             â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ESTADO ACTUAL - FASE 1 COMPLETADA                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚  âœ… Modelos de Datos (4)                                                         â”‚
â”‚  âœ… ConfiguraciÃ³n de AI Providers (OpenAI, Anthropic, Google)                   â”‚
â”‚  âœ… AIProviderService con patrÃ³n Strategy                                        â”‚
â”‚  âœ… AgentPermissionService (delegaciÃ³n y verificaciÃ³n)                           â”‚
â”‚  âœ… Middleware completo (agentAuth)                                              â”‚
â”‚  âœ… API Endpoints (13 rutas)                                                     â”‚
â”‚  âœ… Script de inicializaciÃ³n (npm run init:agents)                              â”‚
â”‚  âœ… DocumentaciÃ³n completa                                                       â”‚
â”‚  âœ… IntegraciÃ³n con server.js                                                    â”‚
â”‚                                                                                   â”‚
â”‚  â³ FASE 2: Orquestador Principal                                                â”‚
â”‚  â³ FASE 3: Product Owner AI Funcional                                           â”‚
â”‚  â³ FASE 4: Entrenamiento y OptimizaciÃ³n                                         â”‚
â”‚  â³ FASE 5: Seguridad Avanzada                                                   â”‚
â”‚  â³ FASE 6: UI/UX                                                                â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
